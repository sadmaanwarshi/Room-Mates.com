<title>Room-Mates - dashboard</title>
<!-- Option 1: Include in HTML -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">
<style>
    
    .card {
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        background-color: #fff;
    }

    .card-title {
        font-size: 1.5rem;
        font-weight: bold;
        color: #333;
    }

    .card-text {
        color: #555;
    }

    .btn-primary {
        background-color: #1e3c72;
        border-color: #1e3c72;
    }

    .btn-primary:hover {
        background-color: #b300ff;
        border-color: #ee00ff;
    }

    .modal-content {
        border-radius: 10px;
        border: none;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .modal-header {
        background-color: #1e3c72;
    }

    .modal-footer .btn {
        border-radius: 5px;
    }

    .modal-body .form-label {
        font-weight: bold;
    }

    .modal-body .form-control {
        border-radius: 8px;
    }
    .card {
    border: 2px solid #e0e0e0;
    border-radius: 10px;
}

.card-title {
    font-size: 1.25rem;
    font-weight: bold;
}

.card-body {
    padding: 1.25rem;
}

.card-text {
    font-size: 1rem;
    line-height: 1.5;
}

.badge {
    font-size: 0.9rem;
}
.card-internal:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        .card-body {
            padding: 10px;
        }

</style>


<%- include("../partials/student/navbar.ejs") %>
<!-- Navbar for Search and Filter -->
<!-- Search Bar Section -->
<!-- Search Bar Section -->
<nav class="navbar navbar-light" style="background: linear-gradient(to right, #40c9ff, #e81cff); height: 60px; margin-bottom: 0;">
    <div class="container-fluid justify-content-center">
        <form class="d-flex mx-auto mt-1" action="/pg/user/search/location" method="GET" style="width: 100%; height: 40px; max-width: 600px;">
            <input class="form-control me-2 w-100" 
                   type="text" 
                   name="search" 
                   placeholder="Enter City..." 
                   aria-label="Search" 
                   style="border-radius: 20px; padding: 10px 20px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);">
            <button class="btn btn-light px-4" 
                    type="submit" 
                    style="border-radius: 20px; font-weight: bold;">Search</button>
        </form>
    </div>
</nav>

<!-- Filter Bar Section -->
<!-- < -->



<!-- Filter Bar Section -->
<nav class="navbar navbar-expand-lg navbar-dark mb-4" style="background: linear-gradient(to right, #40c9ff, #e81cff)">
    <div class="container-fluid justify-content-center flex-wrap gap-3">
        <form action="/pg/user/fetch/filter" method="GET" class="d-flex flex-wrap gap-3 align-items-center">
            <!-- Price Range -->
            <div class="dropdown">
                <button class="btn btn-light dropdown-toggle rounded-pill px-4" type="button" id="priceDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    Max Price
                </button>
                <ul class="dropdown-menu p-3" aria-labelledby="priceDropdown" style="min-width: 250px;">
                    <label for="priceInput" class="form-label">Enter Max Price (â‚¹):</label>
                    <input type="number" class="form-control" name="max_price" id="priceInput" placeholder="e.g., 10000" min="0" max="20000" step="100">
                </ul>
            </div>

            <!-- Amenities -->
            <div class="dropdown">
                <button class="btn btn-light dropdown-toggle rounded-pill px-4" type="button" id="amenitiesDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    Amenities
                </button>
                <ul class="dropdown-menu p-3" aria-labelledby="amenitiesDropdown" style="min-width: 300px;">
                    <div class="d-flex flex-wrap gap-2">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" name="amenities[]" value="WiFi" id="wifi">
                            <label class="form-check-label" for="wifi">
                                <i class="bi bi-wifi"></i> WiFi
                            </label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" name="amenities[]" value="Meal" id="meals">
                            <label class="form-check-label" for="meals">
                                <i class="bi bi-egg-fried"></i> Meals
                            </label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" name="amenities[]" value="AC" id="AC">
                            <label class="form-check-label" for="AC">
                                <i class="bi bi-snow"></i> AC
                            </label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" name="amenities[]" value="Gym" id="gym">
                            <label class="form-check-label" for="gym">
                                <i class="bi bi-dumbbell"></i> Gym
                            </label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" name="amenities[]" value="Laundry" id="laundry">
                            <label class="form-check-label" for="laundry">
                                <i class="bi bi-basket"></i> Laundry
                            </label>
                        </div>
                    </div>
                </ul>
            </div>

            <!-- Gender -->
            <div class="dropdown">
                <button class="btn btn-light dropdown-toggle rounded-pill px-4" type="button" id="genderDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    Gender
                </button>
                <ul class="dropdown-menu p-3" aria-labelledby="genderDropdown" style="min-width: 200px;">
                    <div class="form-check">
                        <input type="radio" class="form-check-input" name="gender" value="Boys" id="boys">
                        <label class="form-check-label" for="boys">Boys</label>
                    </div>
                    <div class="form-check">
                        <input type="radio" class="form-check-input" name="gender" value="Girls" id="girls">
                        <label class="form-check-label" for="girls">Girls</label>
                    </div>
                </ul>
            </div>

            <!-- Rent Type -->
            <div class="dropdown">
                <button class="btn btn-light dropdown-toggle rounded-pill px-4" type="button" id="rentTypeDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    Rent Type
                </button>
                <ul class="dropdown-menu p-3" aria-labelledby="rentTypeDropdown" style="min-width: 200px;">
                    <div class="form-check">
                        <input type="radio" class="form-check-input" name="rent_type" value="Single Room" id="room">
                        <label class="form-check-label" for="room">Single Room</label>
                    </div>
                    <div class="form-check">
                        <input type="radio" class="form-check-input" name="rent_type" value="Flat" id="flat">
                        <label class="form-check-label" for="flat">Flat</label>
                    </div>
                </ul>
            </div>

            <!-- Submit Button -->
            <div>
                <button type="submit" class="btn btn-primary rounded-pill px-4">Apply Filters</button>
            </div>
        </form>
    </div>
</nav>







        

<!-- Main card container -->
<div class="container my-3">
    
    <% if (message) { %>
        <div class="alert alert-primary mt-4 d-flex justify-content-center align-items-center" role="alert" 
             style="background: linear-gradient(to right, #40c9ff, #e81cff); color: white; border-radius: 10px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
            <p class="m-1 text-center" style="font-size: 1.2rem; font-weight: 500;">
                <%= message %>
            </p>
        </div>
    <% } %>
    
    <% if (error) { %>
        <div class="alert alert-danger mt-4 d-flex justify-content-center align-items-center" role="alert" 
             style="background: linear-gradient(to right, #ff4b1f, #ff9068); color: white; border-radius: 10px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
            <p class="m-1 text-center" style="font-size: 1.2rem; font-weight: 500;">
                <%= error %>
            </p>
        </div>
    <% } %>

  <!-- PG Card -->
<div class="card shadow-lg rounded-3 mb-4">
    <div class="card-body">
        <h4 class="card-title text-center mb-3">Hello, <%= user.firstname %>!</h4>
        <h5 class="card-title text-center mb-3">What Kind of PG Accommodation Are You Looking For?</h5>
        <p class="card-text text-center mb-4">Let our supporting team help you find the perfect PG!</p>
        <p class="card-text text-center mb-4"><span class="badge bg-info text-dark"><%= listings.city %></span></p>
        <div class="d-flex justify-content-center">
            <button class="btn btn-primary mb-2" data-bs-toggle="modal" data-bs-target="#requirementModal">
                <i class="bi bi-chat-fill mx-2"></i> Share Requirement
            </button>
        </div>
    </div>
</div>



<!-- Modal: Share Your Requirement -->
<div class="modal fade" id="requirementModal" tabindex="-1" aria-labelledby="requirementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="requirementModalLabel">Share Your Requirement</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="requirementForm">
                    <div class="mb-3">
                        <label for="name" class="form-label">Name</label>
                        <input type="text" class="form-control" id="name" required placeholder="Enter your name">
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" required placeholder="Enter your email">
                    </div>
                    <div class="mb-3">
                        <label for="phone" class="form-label">Phone</label>
                        <input type="tel" class="form-control" id="phone" required placeholder="Enter your phone number">
                    </div>
                    <div class="mb-3">
                        <label for="roomType" class="form-label">Room Type</label>
                        <select class="form-select" id="roomType" required>
                            <option value="" disabled selected>Select room type</option>
                            <option value="Single">Single</option>
                            <option value="Shared">Shared</option>
                            <option value="Deluxe">Deluxe</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="location" class="form-label">Location</label>
                        <input type="text" class="form-control" id="location" required placeholder="Enter desired location">
                    </div>
                    <div class="mb-3">
                        <label for="roomCount" class="form-label">How Many Rooms</label>
                        <input type="number" class="form-control" id="roomCount" required min="1" placeholder="Enter number of rooms">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="submit" class="btn btn-primary" form="requirementForm">Submit</button>
            </div>
        </div>
    </div>
</div>

<!-- Custom Styles -->





    <% if (listings && listings.length > 0) { %>
        <div class="row justify-content-center">
            <% listings.forEach(function(pg) { %>
                
                <div class="col-md-12 mb-3">
                   
                    <div class="card card-internal mx-auto shadow-sm" style="width: 90%; max-width: 800px; border-radius: 12px; transition: transform 0.3s; padding: 10px;">
                        <div class="row g-0">
                            <!-- Image Section -->
                            <div class="col-md-4">
                                <img src="<%= pg.main_image %>" alt="<%= pg.pg_name %>" style="object-fit: cover; width: 100%; height: 220px; border-radius: 12px 0 0 12px;">
                            </div>
                            
                            <!-- Content Section -->
                            <div class="col-md-8">
                                <div class="card-body p-2">
                                    <!-- Header Section: Price, Rent, Room Type, Food Availability -->
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <h5 class="card-title" style="font-size: 1.1rem;">
                                            <i class="bi bi-currency-rupee"></i><%= pg.price_per_month %> / Month
                                        </h5>
                                        
                                        <% if (pg.food_availabilty) { %>
                                            <span class="badge bg-success" style="font-size: 0.8rem;">
                                                <i class="bi bi-check-circle"></i> Included Food
                                            </span>
                                        <% }else{ %>
                                            <span class="badge bg-danger" style="font-size: 0.8rem;">
                                                <i class="bi bi-x-circle"></i> Not-Included Food
                                            </span>
                                            <% } %>
                                    </div>
                                    <div class="d-flex justify-content-end text-muted" style="font-size: 0.85rem;">

                                        <span class="p-1 mx-2 bg-light border"><%= pg.rent_type %></span>
                                        <span class="p-1 bg-light border"><%= pg.room_type %> <i class="bi bi-lightbulb"></i></span>
                                    </div>
    
                                    <!-- PG Details: Name, Address, Description -->
                                    <div class="card mt-2">
                                    <div class="m-2" style="font-size: 0.9rem;">
                                        <p class="m-0"><strong>Name:</strong> <%= pg.pg_name %></p>
                                        <p class="m-0"><strong>Address:</strong> <%= pg.address %>, <%= pg.city %> <i class="bi bi-geo-alt-fill"></i></p>
                                        <p class="mt-2"><strong>Description:</strong> <%= pg.description.split(' ').slice(0, 20).join(' ') %>...
                                            <a href="/pg/user/fetch/pgdetail/<%= pg.id %>" style="font-size: 0.85rem;">Read more</a>
                                        </p>
                                        <p class="m-0"><strong>Available For:</strong> 
                                            <% if (pg.preferred_gender === "Boys") { %>
                                                BOYS
                                            <% }else if (pg.preferred_gender === "Both"){ %>
                                                BOYS and Girls Both
                                                <% }else{ %>
                                                    Girls
                                                    <% } %>
                                        </p>
                                    </div>
                                </div>
                                    <!-- Amenities Section -->
                                    <div class="mt-2">
                                        <strong>Amenities:</strong>
                                        <div class="d-flex flex-wrap" style="font-size: 0.8rem;">
                                            <% Object.entries(pg.amenities).forEach(([key, value]) => { %>
                                                <% if (value === "true") { %>
                                                    <span class="badge bg-primary me-1"><%= key %></span>
                                                <% } %>
                                            <% }); %>
                                        </div>
                                    </div>
    
                                    <!-- Nearby Locations Section -->
                                    <div class="mt-2">
                                        <strong>Nearby:</strong>
                                        <div class="d-flex flex-wrap">
                                            <% pg.nearby_locations.forEach(location => { %>
                                                <span class="badge bg-secondary me-1" style="font-size: 0.75rem;">
                                                    <i class="bi bi-geo-alt-fill"></i> <%= location %>
                                                </span>
                                            <% }) %>
                                        </div>
                                    </div>
    
                                    <!-- Action Buttons -->
                                    <div class="mt-2 d-flex">
                                        <a href="/pg/user/fetch/pgdetail/<%= pg.id %>" class="btn btn-primary btn-sm me-2">View Details</a>
                                        <a href="#" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#bookingModal-<%= pg.id %>">Book Now</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal fade" id="bookingModal-<%= pg.id %>" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content shadow">
                            <!-- Modal Header -->
                            <div class="modal-header" style="background: linear-gradient(to right, #40c9ff, #e81cff);">
                                <h5 class="modal-title text-white" id="bookingModalLabel">Book Your Stay</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            
                            <!-- Modal Body -->
                            <div class="modal-body">
                                <form class="row g-4 needs-validation" action="/pg/user/book/pg/<%= pg.id %>" method="POST" novalidate>
                                    <!-- Stay Duration -->
                                    <div class="col-md-6">
                                        <label for="leaseYear" class="form-label">How Many Months Do You Want to Stay?</label>
                                        <input type="number" class="form-control" id="leaseYear" name="leaseYear" placeholder="Enter duration in months" min="1" max="36" required>
                                        <div class="invalid-feedback">Please specify the duration of your stay.</div>
                                    </div>
                
                                    <!-- Number of Rooms -->
                                    <div class="col-md-6">
                                        <label for="roomsRequested" class="form-label">Number of <%= pg.rent_type %></label>
                                        <select class="form-select" id="roomsRequested" name="roomsRequested" required>
                                            <option selected disabled value="">Choose...</option>
                                            <option value="1">1 <%= pg.rent_type %></option>
                                            <option value="2">2 <%= pg.rent_type %></option>
                                            <option value="3">3 <%= pg.rent_type %></option>
                                            <option value="4">4 <%= pg.rent_type %></option>
                                            <option value="5">5 <%= pg.rent_type %></option>
                                        </select>
                                        <div class="invalid-feedback">Please select the number of rooms.</div>
                                    </div>
                
                                    <!-- Check-In Date -->
                                    <div class="col-md-6">
                                        <label for="checkIn" class="form-label">Check-In Date</label>
                                        <input type="date" class="form-control" id="checkIn" name="checkIn" required>
                                        <div class="invalid-feedback">Please provide a check-in date.</div>
                                    </div>
                
                                    <!-- Terms and Agreement -->
                                    <div class="col-12">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="agreeTerms" required>
                                            <label class="form-check-label" for="agreeTerms">
                                                I agree to the <a href="/terms" class="text-primary text-decoration-none">terms and conditions</a>.
                                            </label>
                                            <div class="invalid-feedback">You must agree to the terms before submitting.</div>
                                        </div>
                                    </div>
                
                                    <!-- Submit Button -->
                                    <div class="col-12 text-center">
                                        <button class="btn btn-primary w-50" type="submit">Confirm Booking</button>
                                    </div>
                                </form>
                            </div>
                            
                            <!-- Modal Footer -->
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>

                
            <% }); %>
        </div>
    <% } else { %>
        <!-- <p>No accommodations found. Try searching by city.</p> -->
    <% } %>

    

<!-- end of container -->
</div>

<%- include("../partials/footer.ejs") %>
<!-- JavaScript to handle the button click and open Google Maps -->
<script>
    async function openOnMap(pgId) {
        console.log(`Fetching location for PG ID: ${pgId}`);
        try {
            const response = await fetch(`/pg/user/pglocation/${pgId}`);
            const data = await response.json();

            if (response.ok) {
                const { latitude, longitude } = data;
                // Open Google Maps with the PG location
                const googleMapsUrl = `https://www.google.com/maps?q=${latitude},${longitude}`;
                window.open(googleMapsUrl, "_blank");
            } else {
                alert(data.error || "Failed to fetch location");
            }
        } catch (error) {
            console.error("Error fetching location:", error);
            alert("Error fetching location");
        }
    }
</script>

